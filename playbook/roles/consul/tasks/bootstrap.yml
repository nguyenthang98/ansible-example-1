---
- name: Prepare to bootstrap Consul
  import_role:
    name: common
    tasks_from: service_prepare
  vars:
    service_config: "{{ consul }}"

- name: Create consul files from template
  become: true
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: vagrant
    group: sudo
    mode: "0755"
  with_items:
    - {src: "docker-compose.yml.j2", dest: "{{ consul.compose_dir }}/{{ consul.compose_file }}"}
    - {src: "consul.hcl.j2", dest: "{{ consul.config_dir }}/consul.hcl"}
    - {src: "daemon.sh.j2", dest: "{{ consul.config_dir }}/consul.daemon.sh"}

- name: Deploy Consul
  import_role:
    name: common
    tasks_from: service_up
  vars:
    service_compose_file: "{{ consul.compose_dir }}/{{ consul.compose_file }}"
    service_ports:
      - 8500
      - 8600

- name: Join Cluster
  run_once: true
  shell: >
    docker-compose -f {{ consul.compose_dir }}/docker-compose.yml exec consul
    consul join {{ groups['consul'] | map('extract', hostvars, 'ansible_host') | list | join(' ') }}
  delegate_to: "{{ groups['consul'] | first }}"
  when: groups['consul']|length > 1

- name: Start daemon for consul service
  block:
    - name: kill all previous running consul daemon
      shell: pkill -f '/bin/bash -c {{ consul.config_dir }}/consul.daemon.sh'
      failed_when: false
    - name: start the consul daemon
      shell: >
        nohup /bin/bash -c '{{ consul.config_dir }}/consul.daemon.sh {{ ansible_host }}' >/tmp/consul.log 2>&1 3>&1 &

- name: Forward DNS traffic to consul using iptables (PREROUTING)
  become: yes
  iptables:
    table: nat
    chain: PREROUTING
    protocol: "{{ item }}"
    match: "{{ item }}"
    destination_port: 53
    jump: REDIRECT
    to_ports: 8600
    comment: CONSUL - Redirect DNS traffic to port 8600
    state: present
  with_items:
    - tcp
    - udp

- name: Forward DNS traffic to consul using iptables (OUTPUT)
  become: yes
  iptables:
    table: nat
    chain: OUTPUT
    protocol: "{{ item }}"
    match: "{{ item }}"
    destination: localhost
    destination_port: 53
    jump: REDIRECT
    to_ports: 8600
    comment: CONSUL - Redirect DNS traffic to port 8600
    state: present
  with_items:
    - tcp
    - udp

